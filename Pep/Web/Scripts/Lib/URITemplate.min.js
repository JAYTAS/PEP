(function(n,t){typeof define=="function"&&define.amd?define([],t):typeof module!="undefined"&&module.exports?module.exports=t():n.UriTemplate=t()})(this,function(){function n(n){return encodeURI(n).replace(/%25[0-9][0-9]/g,function(n){return"%"+n.substring(3)})}function u(t){var c="",l,f,a,v,y,p,w,nt;i[t.charAt(0)]&&(c=t.charAt(0),t=t.substring(1));var s="",e="",h=!0,o=!1,b=!1;c=="+"?h=!1:c=="."?(e=".",s="."):c=="/"?(e="/",s="/"):c=="#"?(e="#",h=!1):c==";"?(e=";",s=";",o=!0,b=!0):c=="?"?(e="?",s="&",o=!0):c=="&"&&(e="&",s="&",o=!0);var k=[],d=t.split(","),u=[],g={};for(l=0;l<d.length;l++){for(f=d[l],a=null,f.indexOf(":")!=-1&&(v=f.split(":"),f=v[0],a=parseInt(v[1])),y={};r[f.charAt(f.length-1)];)y[f.charAt(f.length-1)]=!0,f=f.substring(0,f.length-1);p={truncate:a,name:f,suffices:y};u.push(p);g[f]=p;k.push(f)}return w=function(t){for(var f,i,c,v,l,r="",y=0,a=0;a<u.length;a++){if(f=u[a],i=t(f.name),i==null||Array.isArray(i)&&i.length==0||typeof i=="object"&&Object.keys(i).length==0){y++;continue}if(r+=a==y?e:s||",",Array.isArray(i))for(o&&(r+=f.name+"="),c=0;c<i.length;c++)c>0&&(r+=f.suffices["*"]?s||",":",",f.suffices["*"]&&o&&(r+=f.name+"=")),r+=h?encodeURIComponent(i[c]).replace(/!/g,"%21"):n(i[c]);else if(typeof i=="object"){o&&!f.suffices["*"]&&(r+=f.name+"=");v=!0;for(l in i)v||(r+=f.suffices["*"]?s||",":","),v=!1,r+=h?encodeURIComponent(l).replace(/!/g,"%21"):n(l),r+=f.suffices["*"]?"=":",",r+=h?encodeURIComponent(i[l]).replace(/!/g,"%21"):n(i[l])}else o&&(r+=f.name,b&&i==""||(r+="=")),f.truncate!=null&&(i=i.substring(0,f.truncate)),r+=h?encodeURIComponent(i).replace(/!/g,"%21"):n(i)}return r},nt=function(n,t){var a,p,r,k,w,b,i,n,f,d,v,l,c;if(e)if(n.substring(0,e.length)==e)n=n.substring(e.length);else return null;if(u.length==1&&u[0].suffices["*"]){var v=u[0],l=v.name,r=v.suffices["*"]?n.split(s||","):[n],d=h&&n.indexOf("=")!=-1;for(i=1;i<r.length;i++)n=r[i],d&&n.indexOf("=")==-1&&(r[i-1]+=(s||",")+n,r.splice(i,1),i--);for(i=0;i<r.length;i++){for(n=r[i],h&&n.indexOf("=")!=-1&&(d=!0),f=n.split(","),c=0;c<f.length;c++)h&&(f[c]=decodeURIComponent(f[c]));r[i]=f.length==1?f[0]:f}if(o||d){for(a=t[l]||{},c=0;c<r.length;c++)if(p=n,!o||p){if(typeof r[c]=="string"){var n=r[c],y=n.split("=",1)[0],n=n.substring(y.length+1);p=n}else{var n=r[c][0],y=n.split("=",1)[0],n=n.substring(y.length+1);r[c][0]=n;p=r[c]}a[y]!==undefined?Array.isArray(a[y])?a[y].push(p):a[y]=[a[y],p]:a[y]=p}t[l]=Object.keys(a).length==1&&a[l]!==undefined?a[l]:a}else t[l]=t[l]!==undefined?Array.isArray(t[l])?t[l].concat(r):[t[l]].concat(r):r.length!=1||v.suffices["*"]?r:r[0]}else{for(r=u.length==1?[n]:n.split(s||","),k={},i=0;i<r.length;i++){for(w=0;w<u.length-1&&w<i;w++)if(u[w].suffices["*"])break;if(w==i){k[i]=i;continue}else{for(b=u.length-1;b>0&&u.length-b<r.length-i;b--)if(u[b].suffices["*"])break;if(u.length-b==r.length-i){k[i]=b;continue}}k[i]=w}for(i=0;i<r.length;i++)if(n=r[i],n||!o){if(f=n.split(","),d=!1,o){var n=f[0],l=n.split("=",1)[0],n=n.substring(l.length+1);f[0]=n;v=g[l]||u[0]}else v=u[k[i]],l=v.name;for(c=0;c<f.length;c++)h&&(f[c]=decodeURIComponent(f[c]));t[l]=(o||v.suffices["*"])&&t[l]!==undefined?Array.isArray(t[l])?t[l].concat(f):[t[l]].concat(f):f.length!=1||v.suffices["*"]?f:f[0]}}},w.varNames=k,{prefix:e,substitution:w,unSubstitution:nt}}function t(n){if(!(this instanceof t))return new t(n);for(var f=n.split("{"),i=[f.shift()],e=[],o=[],h=[],s=[];f.length>0;){var c=f.shift(),l=c.split("}")[0],a=c.substring(l.length+1),r=u(l);o.push(r.substitution);h.push(r.unSubstitution);e.push(r.prefix);i.push(a);s=s.concat(r.substitution.varNames)}this.fill=function(n){var u,r,t,f;for(n&&typeof n!="function"&&(u=n,n=function(n){return u[n]}),r=i[0],t=0;t<o.length;t++)f=o[t],r+=f(n),r+=i[t+1];return r};this.fromUri=function(n){for(var s,u,f,c,t,o,l={},r=0;r<i.length;r++){if(s=i[r],n.substring(0,s.length)!==s)return undefined;if(n=n.substring(s.length),r>=i.length-1)if(n=="")break;else return undefined;for(u=i[r+1],f=r;;){if(f==i.length-2){if(c=n.substring(n.length-u.length),c!==u)return undefined;o=n.substring(0,n.length-u.length);n=c}else if(u)t=n.indexOf(u),o=n.substring(0,t),n=n.substring(t);else if(e[f+1])t=n.indexOf(e[f+1]),t===-1&&(t=n.length),o=n.substring(0,t),n=n.substring(t);else if(i.length>f+2){f++;u=i[f+1];continue}else o=n,n="";break}h[r](o,l)}return l};this.varNames=s;this.template=n}var i={"+":!0,"#":!0,".":!0,"/":!0,";":!0,"?":!0,"&":!0},r={"*":!0};return t.prototype={toString:function(){return this.template},fillFromObject:function(n){return this.fill(n)}},t});